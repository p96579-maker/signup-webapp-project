<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Admin - 報名名單</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      margin: 0;
      padding: 0;
      color: #e5e7eb;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      padding: 0 16px 40px;
    }
    h1 {
      font-size: 24px;
      margin: 16px 0 8px;
    }
    .subtitle {
      font-size: 14px;
      color: #9ca3af;
      margin-bottom: 20px;
    }
    .card {
      background: #020617;
      border-radius: 16px;
      padding: 20px 18px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
      border: 1px solid #1f2937;
      margin-bottom: 16px;
    }
    .login-title {
      font-size: 18px;
      margin-bottom: 8px;
    }
    label {
      display: block;
      font-size: 14px;
      margin-bottom: 6px;
    }
    input[type="password"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
      box-sizing: border-box;
      margin-bottom: 12px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-primary {
      background: #22c55e;
      color: #022c22;
    }
    .btn-primary:hover {
      background: #16a34a;
    }
    .btn-outline {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }
    .btn-outline:hover {
      background: #111827;
    }
    .error {
      display: none;
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #7f1d1d;
      color: #fecaca;
      font-size: 13px;
    }
    .table-wrapper {
      overflow-x: auto;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #1f2937;
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      color: #9ca3af;
    }
    tr:hover {
      background: #020617;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #4b5563;
      color: #9ca3af;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .badge {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #111827;
      color: #9ca3af;
      border: 1px solid #374151;
    }
    .empty {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>報名系統 Admin</h1>
    <div class="subtitle">輸入管理員密碼登入，查看所有報名名單。</div>

    <div class="card" id="loginCard">
      <div class="login-title">管理員登入</div>
      <form id="loginForm">
        <label for="password">管理員密碼：</label>
        <input type="password" id="password" name="password" required />
        <button type="submit" class="btn btn-primary">登入</button>
      </form>
      <div id="loginError" class="error">密碼錯誤或登入失敗。</div>
    </div>

    <div class="card" id="listCard" style="display:none;">
      <div class="header-row">
        <div>
          <div style="font-size:16px; font-weight:600;">報名名單</div>
          <div style="font-size:12px; color:#9ca3af;" id="countLabel">總共 0 個報名</div>
        </div>
        <div>
          <button id="refreshBtn" class="btn btn-outline" type="button">重新整理</button>
          <button id="logoutBtn" class="btn btn-outline" type="button">登出</button>
        </div>
      </div>

      <div class="tag">只有成功登入的發起人先可以看到以下資料</div>

      <div class="table-wrapper" id="tableWrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>名字</th>
              <th>備註</th>
              <th>報名時間</th>
            </tr>
          </thead>
          <tbody id="tableBody">
          </tbody>
        </table>
      </div>
      <div id="emptyState" class="empty" style="display:none;">
        暫時未有人報名。
      </div>
    </div>
  </div>

  <script>
    const loginCard = document.getElementById('loginCard');
    const listCard = document.getElementById('listCard');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const tableBody = document.getElementById('tableBody');
    const countLabel = document.getElementById('countLabel');
    const emptyState = document.getElementById('emptyState');
    const refreshBtn = document.getElementById('refreshBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    async function fetchSignups() {
      loginError.style.display = 'none';
      try {
        const res = await fetch('/api/signups');
        if (res.status === 401) {
          loginCard.style.display = 'block';
          listCard.style.display = 'none';
          return;
        }
        if (!res.ok) {
          throw new Error('Request failed');
        }
        const data = await res.json();
        if (!data.ok) {
          throw new Error('Server error');
        }
        const list = data.data || [];
        renderTable(list);
        loginCard.style.display = 'none';
        listCard.style.display = 'block';
      } catch (err) {
        console.error(err);
        loginError.textContent = '載入名單失敗，請稍後再試。';
        loginError.style.display = 'block';
      }
    }

    function renderTable(list) {
      tableBody.innerHTML = '';
      if (!list.length) {
        emptyState.style.display = 'block';
      } else {
        emptyState.style.display = 'none';
      }
      list.forEach((item, idx) => {
        const tr = document.createElement('tr');

        const tdIndex = document.createElement('td');
        tdIndex.textContent = idx + 1;
        tr.appendChild(tdIndex);

        const tdName = document.createElement('td');
        tdName.textContent = item.name || '';
        tr.appendChild(tdName);

        const tdNote = document.createElement('td');
        tdNote.textContent = item.note || '';
        tr.appendChild(tdNote);

        const tdTime = document.createElement('td');
        const d = item.createdAt ? new Date(item.createdAt) : null;
        tdTime.textContent = d ? d.toLocaleString() : '';
        tr.appendChild(tdTime);

        tableBody.appendChild(tr);
      });
      countLabel.textContent = `總共 ${list.length} 個報名`;
    }

    loginForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      loginError.style.display = 'none';

      const password = document.getElementById('password').value.trim();
      if (!password) {
        loginError.textContent = '請輸入密碼。';
        loginError.style.display = 'block';
        return;
      }

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          loginError.textContent = '密碼錯誤或登入失敗。';
          loginError.style.display = 'block';
          return;
        }
        document.getElementById('password').value = '';
        fetchSignups();
      } catch (err) {
        loginError.textContent = '登入時發生錯誤，請稍後再試。';
        loginError.style.display = 'block';
      }
    });

    refreshBtn.addEventListener('click', fetchSignups);

    logoutBtn.addEventListener('click', async function () {
      try {
        await fetch('/api/logout', { method: 'POST' });
      } catch (err) {
      }
      loginCard.style.display = 'block';
      listCard.style.display = 'none';
    });

    fetchSignups();
  </script>
</body>
</html>
